# TCP 连接建立
## TCP 三次握手过程是怎样的？
流程图如下，包含三个报文：
- SYN
- SYN + ACK
- ACK+数据（ACK的同时已经可以携带数据了）
![[Pasted image 20240129112350.png]]

## 为什么是三次握手？不是两次、四次？
三次握手的原因：
- 三次握手才可以阻止重复历史连接的初始化（主要原因）
- 三次握手才可以同步双方的初始序列号
- 三次握手才可以避免资源浪费

### 原因一：避免历史连接
**我们先看为什么两次握手无法避免历史连接：**
1. 在两次握手的情况下，服务端在收到 SYN 报文后，就进入 ESTABLISHED 状态，意味着这时可以给对方发送数据，但是客户端此时还没有进入 ESTABLISHED 状态
2. 假设这次是历史连接，客户端判断到此次连接为历史连接，那么就会回 RST 报文来断开连接
3. 而由于服务端无法得知历史连接，只有收到RST报文时才能知道这是历史连接
![[Pasted image 20240129112829.png]]

**接下来看为什么三次握手可以避免历史连接：**
三次握手为服务端提供了一个中间状态，从而可以阻止历史连接的发生。
![[Pasted image 20240129113003.png]]

### 原因二：同步双方初始序列号
TCP 协议的通信双方， 都必须维护一个「序列号」进行报文的保序。序列号通过SYN报文传递，并通过ACK报文确定。通信双方都要有这样一个来回，才能确保收到对方的初始序列号。

事实上四次握手是最直观的上述实现方式，但第二步和第三步可以进行合并，从而提高效率：
![[Pasted image 20240129113448.png]]

### 原因三：避免资源浪费
这主要是针对二次握手可能出现的情况，出现历史连接时，服务端就会建立多个冗余的连接，从而造成资源的浪费。

## 为什么每次建立 TCP 连接时，初始化的序列号都要求不一样呢？
主要原因是，为了防止历史报文被下一个相同四元组的连接接收。如下图：
![[Pasted image 20240129113817.png]]

如果每次连接的初始序列号不同，就可以**大概率避免历史报文被错误地接收**。如果要完全避免，还需要依靠时间戳的机制。

初始序列号ISN的生成方法如下：
- ISN = M + F(localhost, localport, remotehost, remoteport)。
- `M` 是一个计时器，这个计时器每隔 4 微秒加 1。
- `F` 是一个 Hash 算法，根据源 IP、目的 IP、源端口、目的端口生成一个随机数值。

## 握手丢失时，会发生什么
首先我们确定两点：
- ACK报文不会重传
- 主动发送的报文在未收到ACK后，超时并重传

因而对于三次握手的每一种丢失，都有对应的方案：
- 一次握手丢失：没收到ACK，会自行重传
- 二次握手丢失：由于二次握手既是一个ACK也是一个SYN，因而会有以下两种情况：
	- 客户端由于没收到ACK，会重传SYN
	- 服务端没收到客户端的ACK，会重传SYN+ACK
- 三次握手丢失：由于本身是ACK，只有服务端感知到超时后才会重传SYN+ACK

## 什么是 SYN 攻击？如何避免 SYN 攻击？
假设攻击者短时间伪造不同 IP 地址的 `SYN` 报文，服务端每接收到一个 `SYN` 报文，就进入`SYN_RCVD` 状态，但服务端发送出去的 `ACK + SYN` 报文，无法得到未知 IP 主机的 `ACK` 应答，久而久之就会**占满服务端的半连接队列**，使得服务端不能为正常用户服务。
![[Pasted image 20240129115035.png]]

避免SYN攻击，有以下四种方法：
- 调大 netdev_max_backlog；
- 增大 TCP 半连接队列；
- 开启 tcp_syncookies；
- 减少 SYN+ACK 重传次数

### 方式一：调大 netdev_max_backlog
netdev_max_backlog是网卡接收数据包的缓存队列大小，可以增大该值，从而在内核处理不了那么多数据包时进行缓存

### 方式二：增大 TCP 半连接队列
这个就是直接增大半连接队列的大小

### 方式三：开启 net.ipv4.tcp_syncookies
开启 syncookies 功能就可以在不使用 SYN 半连接队列的情况下成功建立连接，相当于绕过了 SYN 半连接来建立连接。

在接收到客户端的第一次握手后，服务端通过算法计算一个`cookie`值放入第二次握手报文中，客户端在第三次握手时携带该`cookie`值，这样服务端就知道这是第三次握手，可以直接放入Accept队列，这样就绕开了半连接队列的存储。

### 方式四：减少 SYN+ACK 重传次数
通过减少 SYN-ACK 的重传次数，以加快处于 SYN_REVC 状态的 TCP 连接断开。

