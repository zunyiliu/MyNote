# 概述
两者不是一个东西：
- HTTP 的 Keep-Alive，是由**应用层（用户态）** 实现的，称为 HTTP 长连接；
- TCP 的 Keepalive，是由 **TCP 层（内核态）** 实现的，称为 TCP 保活机制；

# HTTP 的 Keep-Alive
![[Pasted image 20240224105058.png]]
如果HTTP使用短连接，那么每次流程如上，都需要经过：建立 TCP -> 请求资源 -> 响应资源 -> 释放连接

![[Pasted image 20240224105139.png]]
为了重复使用TCP连接，我们可以使用HTTP长连接，启动Keep-Alive

为了避免HTTP长时间不使用，web 服务软件一般都会提供 `keepalive_timeout` 参数，用来指定 HTTP 长连接的超时时间。在发送一个请求后，如果`keepalive_timeout`时间内都没有新的请求，那么就会释放该连接。

# TCP 的 Keepalive
TCP 的 Keepalive 这东西其实就是 **TCP 的保活机制**，其原理如下：

如果两端的 TCP 连接一直没有数据交互，达到了触发 TCP 保活机制的条件，那么内核里的 TCP 协议栈就会发送探测报文。
- 如果对端程序是正常工作的。当 TCP 保活的探测报文发送给对端, 对端会正常响应，这样 **TCP 保活时间会被重置**，等待下一个 TCP 保活时间的到来。
- 如果对端主机宕机（_注意不是进程崩溃，进程崩溃后操作系统在回收进程资源的时候，会发送 FIN 报文，而主机宕机则是无法感知的，所以需要 TCP 保活机制来探测对方是不是发生了主机宕机_），或对端由于其他原因导致报文不可达。当 TCP 保活的探测报文发送给对端后，石沉大海，没有响应，连续几次，达到保活探测次数后，**TCP 会报告该 TCP 连接已经死亡**。

