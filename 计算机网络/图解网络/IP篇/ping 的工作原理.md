# IP协议的助手 —— ICMP 协议
`ICMP` 全称是 **Internet Control Message Protocol**，也就是**互联网控制报文协议**。

`ICMP` 主要的功能包括：**确认 IP 包是否成功送达目标地址、报告发送过程中 IP 包被废弃的原因和改善网络设置等。**

`ICMP` 报文格式如下：
![[Pasted image 20240221105407.png]]

ICMP 包头的**类型**字段，大致可以分为两大类：
- 一类是用于诊断的查询消息，也就是「**查询报文类型**」
- 另一类是通知出错原因的错误消息，也就是「**差错报文类型**」
![[Pasted image 20240221105419.png]]

## 查询报文类型
**回送消息、查询报文**用于进行通信的主机或路由器之间，判断所发送的数据包是否已经成功到达对端的一种消息，`ping` 命令就是利用这个消息实现的。

## 差错报文类型
- 目标不可达消息 —— 类型 为 `3`
- 原点抑制消息 —— 类型 `4`
- 重定向消息 —— 类型 `5`
- 超时消息 —— 类型 `11`

### 目标不可达消息（Destination Unreachable Message） —— 类型为 `3`
![[Pasted image 20240221105622.png]]

### 原点抑制消息（ICMP Source Quench Message） —— 类型 `4`
当路由器向低速线路发送数据时，其发送队列的缓存变为零而无法发送出去时，可以向 IP 包的源地址发送一个 ICMP **原点抑制消息**。

收到这个消息的主机借此了解在整个线路的某一处发生了拥堵的情况，从而增大 IP 包的传输间隔，减少网络拥堵的情况。

### 重定向消息（ICMP Redirect Message） —— 类型 `5`
如果路由器发现发送端主机使用了「不是最优」的路径发送数据，那么它会返回一个 ICMP **重定向消息**给这个主机。

在这个消息中包含了**最合适的路由信息和源数据**。这主要发生在路由器持有更好的路由信息的情况下。路由器会通过这样的 ICMP 消息告知发送端，让它下次发给另外一个路由器。

### 超时消息（ICMP Time Exceeded Message） —— 类型 `11`
IP 包中有一个字段叫做 `TTL` （`Time To Live`，生存周期），它的**值随着每经过一次路由器就会减 1，直到减到 0 时该 IP 包会被丢弃。**

此时，路由器将会发送一个 ICMP **超时消息**给发送端主机，并通知该包已被丢弃。

# ping —— 查询报文类型的使用
![[Pasted image 20240221105836.png]]

# traceroute —— 差错报文类型的使用
有一款充分利用 ICMP **差错报文类型**的应用叫做 `traceroute`（在UNIX、MacOS中是这个命令，而在Windows中对等的命令叫做 tracert ）。

## 作用一：追踪去往目的地时沿途经过的路由器
traceroute 的第一个作用就是**故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。**

原理就是利用 IP 包的**生存期限** 从 `1` 开始按照顺序递增的同时发送 **UDP 包**，强制接收 **ICMP 超时消息**的一种方法。

## 作用二：确定路径MTU
traceroute 还有一个作用是**故意设置不分片，从而确定路径的 MTU**。