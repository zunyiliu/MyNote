- [[#以太网交换基础|以太网交换基础]]
	- [[#以太网交换基础#以太网协议|以太网协议]]
	- [[#以太网交换基础#以太网帧|以太网帧]]
	- [[#以太网交换基础#以太网交换机|以太网交换机]]
- [[#VLAN|VLAN]]
- [[#VLAN间的通信|VLAN间的通信]]
	- [[#VLAN间的通信#背景|背景]]
	- [[#VLAN间的通信#使用路由器实现VLAN间通信|使用路由器实现VLAN间通信]]
	- [[#VLAN间的通信#使用VLANIF技术实现VLAN间通信|使用VLANIF技术实现VLAN间通信]]
	- [[#VLAN间的通信#三层通信过程解析|三层通信过程解析]]
- [[#链路聚合、堆叠和集群|链路聚合、堆叠和集群]]
	- [[#链路聚合、堆叠和集群#网络可靠性|网络可靠性]]
	- [[#链路聚合、堆叠和集群#链路聚合技术|链路聚合技术]]
	- [[#链路聚合、堆叠和集群#堆叠与集群|堆叠与集群]]
- [[#生成树|生成树]]
	- [[#生成树#技术背景|技术背景]]
	- [[#生成树#生成树协议|生成树协议]]
	- [[#生成树#STP（消除环路协议）|STP（消除环路协议）]]
		- [[#STP（消除环路协议）#基本概念|基本概念]]
		- [[#STP（消除环路协议）#STP工作过程|STP工作过程]]
		- [[#STP（消除环路协议）#拓扑变化对STP影响|拓扑变化对STP影响]]
	- [[#生成树#RSTP|RSTP]]
		- [[#RSTP#STP不足之处|STP不足之处]]
		- [[#RSTP#RSTP改进|RSTP改进]]
	- [[#生成树#生成树技术进阶|生成树技术进阶]]
		- [[#生成树技术进阶#VBST：基于VLAN的生成树|VBST：基于VLAN的生成树]]
		- [[#生成树技术进阶#MSTP：多生成树|MSTP：多生成树]]
		- [[#生成树技术进阶#堆叠与生成树|堆叠与生成树]]


# 以太网交换基础
## 以太网协议
以太网是局域网（LAN）的协议，采用CSMA/CD的方法

**冲突域**
![[Pasted image 20231020102131.png]]
**广播域**
![[Pasted image 20231020102150.png]]
**以太网卡**
一块网卡包括OSI 模型的两个层，物理层和数据链路层

网卡的功能主要有两个：
1. 将电脑的数据封装为帧，并通过网线(对无线网络来说就是电磁波)将数据发送到网络上去
2. 接收网络上其它设备传过来的帧，并将帧重新组合成数据，发送到所在的电脑中

## 以太网帧
![[Pasted image 20231020102558.png]]
详细可见计网部分的以太网帧：
![[Pasted image 20231018101644.png]]

**MAC地址**
![[Pasted image 20231020102947.png]]
单播就是点对点发送
组播是向部分设备发送
广播是向所有设备发送

## 以太网交换机
以太网二层交换机转发数据的端口都是以太网口，并且只能够针对数据的二层头部 (以太网数据帧头) 中的MAC地址进行寻址并转发数据。

其他特性可在计网中查询

# VLAN
**VLAN基本概念**
VLAN就是将一个物理交换机划分为多个虚拟交换机，类似下图：
![[Pasted image 20231020110708.png]]

交换机之间需要进行帧的交换，就涉及到如何识别不同VLAN的帧：
![[Pasted image 20231020110800.png]]

我们在帧中加入Tag字段，从而识别不同VLAN。
![[Pasted image 20231020110826.png]]

**VLAN划分方式**
![[Pasted image 20231020111146.png]]

**VLAN中的接口**
![[Pasted image 20231020112745.png]]
Access接口一般用于和不能识别Tag的用户终端（如用户主机、服务器）相连：用户终端无法识别何添加VLAN ID，因而需要由交换机完成。

Trunk接口一般用于连接交换机、路由器、AP：负责将带有tag的帧进行相互传递

Hybrid（杂交）接口既可以用于连接不能识别Tag的用户终端（如用户主机、服务器）和网络设备（如Hub），也可以用于连接交换机、路由器。

一般还是Access和Trunk两种接口用的多。

**VLAN应用**
![[Pasted image 20231020113816.png]]
![[Pasted image 20231020113827.png]]

# VLAN间的通信
## 背景
![[Pasted image 20231025184941.png]]

## 使用路由器实现VLAN间通信
**方法一：使用路由器物理接口**
![[Pasted image 20231025185102.png]]
在交换机到路由器之间使用多个物理接口，配置为Access类型接口。这样在交换机内带有VLAN tag的帧就会从对应Access接口发出，路由器就可以接收不同VLAN id的报文，并进行对应转发。

**方法二：使用路由器子接口**
![[Pasted image 20231025185303.png]]
在交换机到路由器之间只使用一个物理接口，配置多个虚拟子接口，这样就要求交换机的出口为Trunk类型的接口。

![[Pasted image 20231025185425.png]]

整个流程：
1. 主机发送帧到交换机
2. 交换机将该帧打上对应Access接口的VLAN tag
3. 交换机从Trunk接口发出带有VLAN tag的帧
4. 路由器接收到帧后，匹配对应的子接口，然后就去掉VLAN tag
5. 路由器匹配路由表，从对应的子接口发出，再次打上VLAN tag
6. 交换机接收到带有不同VLAN tag的帧
7. 交换机将该帧从对应Access接口发出，并把tag去掉。
8. 帧最终以不带tag的形式到达目标主机

## 使用VLANIF技术实现VLAN间通信
![[Pasted image 20231025190857.png]]
实际上就是利用三层交换机自带的路由模块，可以实现交换机内部通信。注：三层交换机采用MAC地址进行路由，实际上二层交换机接口是不带MAC地址的。

![[Pasted image 20231025191345.png]]

## 三层通信过程解析
建议直接看对应pdf


# 链路聚合、堆叠和集群
## 网络可靠性
![[Pasted image 20231021120134.png]]
本节主要讲述链路可靠性的实现。

## 链路聚合技术
**链路聚合技术基本原理**
![[Pasted image 20231021120252.png]]
![[Pasted image 20231021120304.png]]
其中成员接口指的是聚合后拥有的接口。活动接口指的是当前能够使用的接口。

**链路聚合模式**
链路聚合模式分为手动模式和LACP模式。手动模式用于老旧设备，只能通过管理员进行配置，出现故障也只能由管理员进行处理。而LACP模式可以自行配置、自主处理故障。

**LACP模式**
![[Pasted image 20231021120525.png]]
1. 首先根据设备优先级选出主动端，其中值越小优先级越高。主动端将选择活动接口，被动端将接受主动端选择的活动接口。
2. 选出主动端后，两端都会以主动端的接口优先级来选择活动接口，优先级高的接口将优先被选为活动接口。接口LACP优先级值越小，优先级越高。
3. 主动端将选举的活动接口结果告知被动端，被动端明确本端的活动接口，同时对应的链路成为活动链路
4. 至此，Eth-Trunk的活动链路选举过程完成


**关于最大接口数**：
![[Pasted image 20231021120757.png]]
![[Pasted image 20231021120815.png]]


**负载分担**
![[Pasted image 20231021121137.png]]

## 堆叠与集群
![[Pasted image 20231021121220.png]]
- 逻辑上一台设备，简化运维，方便管理。
- 一台物理设备故障，其他设备可以接管转发、控制平台，避免了单点故障
- 跨设备的链路聚合，物理上的无环网络，无需再部署STP
- 链路聚合中的链路全部有效使用，链路利用率100%。

![[Pasted image 20231021121339.png]]

# 生成树
## 技术背景
![[Pasted image 20231022101323.png]]
造成二层环路的原因很多，最常见的就是交换机与链路冗余导致的二层环路。此处二层指的是第二层也就是链路层，三层环路因为路由器的动态路由协议有一定防环能力，因而基本不存在问题。

- 广播风暴：以太网帧没有TTL，因而广播帧会在环路中不停转发。
- MAC地址漂移：由环路广播引发，一台设备可能在不同接口收到同一个MAC地址的广播帧，导致ARP表不断变化，这就是MAC地址漂移（从一个接口变到另一个接口）

## 生成树协议
![[Pasted image 20231022102008.png]]
按照字面意义，生成树就是在一个图中生成一个树，即一个无环图，这样就打破了环路。

![[Pasted image 20231022102053.png]]
![[Pasted image 20231022102153.png]]

## STP（消除环路协议）
### 基本概念
![[Pasted image 20231022103055.png]]
![[Pasted image 20231022103105.png]]
![[Pasted image 20231022103125.png]]
![[Pasted image 20231022103136.png]]
![[Pasted image 20231022103147.png]]
![[Pasted image 20231022103201.png]]
![[Pasted image 20231022103238.png]]

### STP工作过程
1. 在交换网络中选举一个根桥
	- 拥有最小桥ID的交换机成为根桥
	- 通常在组网前就选好根桥，并将其桥优先级设置为0
2. 每个非根桥（根桥不用）选举一个根接口
	- 根接口为收到最有BPDU的接口
	- 可以简单理解为朝向根桥的接口
3. 每条链路（网段）选举指定接口
	- 每个网段只会有一个指定接口
	- 将根接口收到的BPDU与当前接口收到的BPDU进行比较，
		- 前者更优，则该接口为指定接口（说明从这个接口转发BPDU更好）
		- 后者更优，则该接口为非指定接口（说明不如从该网段的其他接口接收）
	- 根桥所有接口都是指定接口（毕竟就从这里发出BPDU）
4. 将非指定接口阻塞
	- 这样我们就完成了破环

最优BPDU的比较方式：
![[Pasted image 20231022104634.png]]


### 拓扑变化对STP影响
![[Pasted image 20231022104406.png]]
![[Pasted image 20231022104420.png]]

## RSTP
### STP不足之处
![[Pasted image 20231022105250.png]]

### RSTP改进
1. 引入新的接口角色：备份端口、边缘端口，通过接口角色的增补，简化了生成树协议的理解及部署。
2. RSTP状态优化为三种
3. 对BPDU的处理改变

## 生成树技术进阶
### VBST：基于VLAN的生成树
![[Pasted image 20231022110350.png]]
![[Pasted image 20231022110409.png]]

### MSTP：多生成树
![[Pasted image 20231022110535.png]]

### 堆叠与生成树
![[Pasted image 20231022110621.png]]
