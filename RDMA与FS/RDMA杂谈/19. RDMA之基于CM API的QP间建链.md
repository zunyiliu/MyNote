# 概述
CM这一缩写有多重含义，它既可以指协议，也可以指RDMA网络中的一个管理角色，还可以指编程接口（API）。

## 通信管理协议
CM在作为协议时的全称为Communication Management Protocol，即通信管理协议。它指的是一种建立于Infiniband/RoCE协议基础之上的建链方式。

## 通信管理器
CM作为Infiniband/RoCE通信系统中的角色时，全称为Communication Manager，即通信管理器。**RDMA软件协议栈中实现了CM管理器的功能**。

## CM编程接口
CM作为Infiniband/RoCE/iWARP的用户编程接口时，全称也是Communication Manager，即通信管理接口。

CM接口之于CM协议，就如Socket接口之于TCP协议，其调用流程也和Socket非常相似，我们也可以说，CM API是基于RDMA而非传统以太网实现的类Socket接口。

![[Pasted image 20240122112538.png]]

# 为什么需要CM
Infiniband协议没有Socket这种通道来在双方交换业务数据前传递必要的信息，比如QPN、Virtual Address和Remote Key等等。它需要一种不依赖于以太网的QP间建联方式，所以会有CM协议和通信管理器的存在。

# CM协议
## RC QP建链
RC QP的CM建链和断链流程和TCP非常相似，如下图所示，建链是一个“三次握手”的流程：
![[Pasted image 20240122112658.png]]
1. 首先Client端要发起一个REQ（Request）消息，表示一个连接请求，消息的报文中携带有连接参数，比如本端要连接的QP的QPN（这个QP是在CM建链流程中通过CM API创建的，下文会介绍）、起始PSN、重传次数上限等等。
2. Server端在Client端发起连接请求前就一直处于监听状态，当它监听到连接请求后，CM层会对连接参数进行校验和记录，而Private Data会被上送给用户进行校验。校验通过后，Server端会发送REP（Reply）消息，表示接受之前的连接请求，并且在消息报文中携带自己的连接参数——包括QPN、起始PSN等等。
3. Client端收到REP消息后，将对其中的内容进行校验和记录，然后发送一个RTU（Ready To Use）消息，表示同意你的参数，可以利用双方约定好的QP进行数据交互了。

## RC QP断链
RC QP的断链一般是一个“四次挥手“的过程。
![[Pasted image 20240122112750.png]]
1. 首先Client端发送DREQ（Disconnect Request）消息，表示自己想要断开某个连接，消息中携带着指定连接的ID以及QPN等信息。这个过程也可以携带Private Data，用于定制化功能。
2. Server端收到DREQ消息并校验通过后，回复一个DREP（Disconnect Reply）消息，表示同意断链请求。
3. Server端发送DREQ消息，同1。
4. Client端收到DREQ消息，校验通过后回复DREP，同2。

## UD QP建链
UD QP的CM建链流程相对于RC要简单，主要原因自然是UD服务类型不用建立连接，也不需要保证可靠性，对端收不收的到无所谓。由上层应用的逻辑保证建链的完成，比如Client端可以在一定时间内没收到Reply就重发Request。
![[Pasted image 20240122112848.png]]
1. Client端发送请求消息SIDR_REQ（SIDR Request），其中会携带一个Service ID字段，表明它需要Server端提供的服务。这个过程中也可以携带Private Data用于定制化实现。
2. Server端收到SIDR_REQ消息后，会对请求进行校验。校验通过后，在回复消息SIDR_REP（SIDR Reply）中会携带一个和Service ID对应的可用QP的QPN以及Queue Key，此后Client就可以以它为目的QP发送数据给Server。这个过程中也可以携带Private Data。

