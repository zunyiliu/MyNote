# 概述
QP是一个数据结构，包含硬件上的空间和软件上的结构管理：
- 硬件上，QP是一段包含着若干个WQE的存储空间，IB网卡会从这段空间中读取WQE的内容，并按照用户的期望去内存中存取数据。
- 软件上，QP是一个由IB网卡的驱动程序所维护的数据结构，其中包含QP的地址指针以及一些相关的软件属性。

# QPC
QPC负责管理硬件上的QP信息，用于在软硬件之间同步QP的信息。

网卡及其配套的驱动程序提前约定好了QPC中都有哪些内容，这些内容分别占据多少空间，按照什么顺序存放。这样驱动和硬件就可以通过通过QPC这段空间来读写QP的状态等等信息。
![[Pasted image 20240115143400.png]]

# QP Number
简称为QPN，就是每个QP的编号。IB协议中规定用24个bit来表示QPN，即每个节点最大可以同时使用$2^{24}$个QP。每个节点都各自维护着QPN的集合，相互之间是独立的，即不同的节点上可以存在编号相同的QP。

# 用户接口
用户接口包括控制层面和数据层面，控制面即用户对某种资源进行某种设置，一般都是在正式收发数据之前进行；而数据面自然就是真正的数据收发过程中进行的操作。

## 控制面
QP的操作接口如下，可与链表进行对比：
![[Pasted image 20240115143642.png]]

## 数据面
数据面上，一个QP对上层的接口其实只有两种，分别用于向QP中填写发送和接收请求。**这里的“发送”和“接收”并不是指的发送和接收数据，而是指的是一次通信过程的“发起方”（Requestor）和“接收方”（Responser）**：
- Post Send Request：用户需要提前准备好数据缓冲区、目的地址等信息，然后调用接口将WR传给驱动，驱动再把WQE填写到QP中。
- Post Receive Request：接收端需要提前准备好接收数据的缓冲区，并将缓冲区地址等信息以WQE的形式告知硬件。

# QP状态机
![[Pasted image 20240115143901.png]]

对应的每一个状态如下：
![[Pasted image 20240115144052.png]]

