# RoCE
## RoCE的协议层次
RoCE v2的一个报文层次如下：
![[Pasted image 20240117115300.png]]
- Infiniband传输层报文实际上是UDP层的负载，也就是深蓝色背景的部分。
- UDP报文头中有一个字段Destination Port Number（目的端口号），对于RoCE v2来说固定是4791，当对端网卡收到报文后，会根据该字段识别是普通的以太网数据包，还是RoCE数据包，或者是其他协议的数据包，然后再进行解析。
- 深蓝色背景的IB传输层部分又分成了IB报头，实际的用户数据（Payload）以及校验部分。

## RoCE的优势
为什么我们有了Infiniband协议之后，还要设计RoCE协议呢？最主要的原因还是成本问题：
- Infiniband协议本身定义了一套全新的层次架构，从链路层到传输层，都无法与现有的以太网设备兼容。
- 如果某个数据中心因为性能瓶颈，想要把数据交换方式从以太网切换到Infiniband技术，那么需要购买全套的Infiniband设备，包括网卡、线缆、交换机和路由器等等
- RoCE协议的出现解决了这一问题，如果用户想要从以太网切换到RoCE，那么**只需要购买支持RoCE的网卡就可以了**，线缆、交换机和路由器（RoCE v1不支持以太网路由器）等网络设备都是兼容的——因为我们只是在以太网传输层基础上又定义了一套协议而已。

## Soft-RoCE
RoCE已经降低了很多成本，但对于个人开发者来说，专用的RoCE网卡仍然昂贵，因而可以采用Soft-RoCE。

Soft-RoCE就是把本来应该卸载到硬件的封包和解析工作，又拿到软件来做。其本身是基于Linux内核的TCP/IP协议栈实现的，网卡本身并不感知收发的数据包是RoCE报文，其驱动程序按照IB规范中的报文格式将用户数据封装成IB传输层报文，然后把报文整体当做数据填入Socket Buffer当中，由网卡进行下一步收发包处理。

Soft-RoCE有以下优势：
- 降低RoCE部署成本：Soft-RoCE可以使不具备RoCE能力的硬件和支持RoCE的硬件间进行基于IB语义的交流，这样可以**免于替换网络中的一些非关键节点的旧型号网卡**。
- 便于开发和测试RDMA程序：有了Soft-RoCE，我们基于Verbs API编写的程序，就可以不依赖于硬件执行起来，也可以很方便的跑在虚拟机里。

# 实验

跟着[教程](https://zhuanlan.zhihu.com/p/361740115)跑了下测试，就是体验了一下。