# 引论
RDMA从内存中取出数据时不会经过CPU，然而在用户空间中的数据地址都是虚拟地址（Virtual Address，下文称VA），经过MMU的转换才能得到真实的物理地址（Physical Address，下文称PA）。我们的**RDMA网卡是如何得到PA从而去内存中拿到数据的呢**？就算网卡知道上哪去取数据，**如果用户恶意指定了一个非法的VA，那网卡岂不是有可能被“指使”去读写关键内存**？

为解决该问题，IB提出了MR的概念

# MR是什么
MR全称为Memory Region，指的是由RDMA软件层在内存中规划出的一片区域，用于存放收发的数据。

在对IB协议进行相关描述时，我们通常称RDMA硬件为**HCA（Host Channel Adapter， 宿主通道适配器）**

# 为什么要注册MR
## 1. 注册MR以实现虚拟地址与物理地址转换
注册MR的过程中，硬件会在内存中创建并填写一个VA to PA的映射表，这样需要的时候就能通过查表把VA转换成PA了。

![[Pasted image 20240110144914.png]]
在上图情况中，会经历以下过程：
- 首先本端APP会下发一个WQE给HCA，告知HCA，用于存放待发送数据的本地Buffer的虚拟地址，以及即将写入的对端数据Buffer的虚拟地址。
- 本端HCA查询VA->PA映射表，得知待发数据的物理地址，然后从内存中拿到数据，组装数据包并发送出去。
- 对端HCA收到了数据包，从中解析出了目的VA。
- 对端HCA通过存储在本地内存中的VA->PA映射表，查到真实的物理地址，核对权限无误后，将数据存放到内存中。

## 2. MR可以控制HCA访问内存的权限
用户注册MR的动作会产生两把钥匙——L_KEY（Local Key）和R_KEY（Remote Key）。它们将分别用于保障对于本端和远端内存区域的访问权限。

两端的节点在真正的RDMA通信之前，会通过某些方式先建立一条链路（可能是Socket连接，也可能是CM连接）并通过这条链路交换一些RDMA通信所必须的信息（VA，Key，QPN等），我们称这一过程叫做“建链”和“握手”。**这样通信双方就拿到了对方的key**。

## 3. MR可以避免换页
为了避免MR区域被操作系统进行换页，注册MR时会"Pin"住这块内存（亦称“锁页”），即锁定VA-PA的映射关系。也就是说，MR这块内存区域会长期存在于物理内存中不被换页，直到完成通信之后，用户主动注销这片MR。

