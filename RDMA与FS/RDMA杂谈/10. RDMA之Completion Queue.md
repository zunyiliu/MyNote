# 概述
CQ意为完成队列，它的作用和WQ（SQ和RQ）相反，硬件通过CQ中的CQE/WC来告诉软件某个WQE/WR的完成情况。其中对于上层用户来说一般用WC，对于驱动程序来说，一般称为CQE。
![[Pasted image 20240115151006.png]]

# 何时产生CQE
## 可靠服务类型（RC）
- SEND：发送方收到这ACK之后才会产生CQE
- RECV：硬件将收到的数据放到用户WQE中指定的内存区域，完成校验和数据存放动作后，就会产生CQE
- WRITE：对于Client端来说，WRITE操作和SEND操作是一样的，也是在收到ACK后产生CQE。而对端CPU不感知
- READ：对于Client端来说，READ和RECV基本一样，在收到ACK（包括数据）后产生CQE

## 不可靠服务类型（UD）
因为不可靠的服务类型没有重传和确认机制，所以产生CQE表示硬件**已经将对应WQE指定的数据发送出去了**。

# WQ与CQ的对应关系
- 每个WQ都必须关联一个CQ，而每个CQ可以关联多个SQ和RQ
![[Pasted image 20240115151443.png]]
- 同一个WQ中的WQE，其对应的CQE间是保序的
- 不同WQ中的WQE，其对应的CQE间是不保序的
- CQE通过指明WQE的编号关联WQE
![[Pasted image 20240115151511.png]]

# 完成错误
IB协议中有三种错误类型，立即错误（immediate error）、完成错误（Completion Error）以及异步错误（Asynchronous Errors)：
- 立即错误的是“立即停止当前操作，并返回错误给上层用户”；
- 完成错误指的是“通过CQE将错误信息返回给上层用户”；
- 异步错误指的是“通过中断事件的方式上报给上层用户”；

完成错误的检测如下：
![[Pasted image 20240115151847.png]]

# 用户接口
CQ的用户接口同QP一样，同样分为控制面和数据面，其中数据面的接口基本相同，**主要讲述数据面的接口**。

网卡收到数据包后如何让CPU知道这件事，并进行数据包处理，有两种常见的模式：
- 中断模式：当网卡收到数据包时，会上报中断打断CPU当前的任务，CPU转而来处理数据包
- 轮询模式：CPU每隔一段时间会去检查网卡是否受到数据。如果有数据，就把缓冲区里的数据一波带走进行处理，没有的话就接着处理别的任务。

