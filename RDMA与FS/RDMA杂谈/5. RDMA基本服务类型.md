RDMA的基本通信单元是QP，而基于QP的通信模型有很多种，我们在RDMA领域称其为“服务类型”。IB协议中通过“可靠”和“连接”两个维度来描述一种服务类型。

# 可靠
通信中的可靠性指的是通过一些机制保证发出去的数据包都能够被正常接收。

IB通过以下三个机制来保证可靠性：
## 应答机制
通过应答包或ACK实现应答机制。IB的可靠服务类型中，接收方不是每一个包都必须回复，也可以一次回复多个包的ACK。
![[Pasted image 20240109171202.png]]

## 数据校验机制
发端会对Header和Payload（有效载荷，也就是真正要收发的数据）通过一定的算法得到一个**校验值**放到数据包的末尾。对端收到数据包后，也会用相同的算法计算出校验值，然后与数据包中的校验值比对，如果不一致，说明数据中包含错误（一般是链路问题导致的），那么接收端就会丢弃这个数据包。
![[Pasted image 20240109171252.png]]

## 保序机制
保序指的是，保证先被发送到物理链路上的数据包一定要先于后发送的数据包被接收方收到。IB协议中有PSN（Packet Sequence Number，包序号）的概念，即每个包都有一个递增的编号。PSN可以用来检测是否丢包，比如收端收到了1，但是在没收到2的情况下就收到了3，那么其就会认为传输过程中发生了错误，之后会回复一个NAK给发端，让其重发丢失的包。
![[Pasted image 20240109171335.png]]

# 连接与数据报
**连接**是一条通信的“管道”，一旦管道建立好了，管道这端发出的数据一定会沿着这条管道到达另一端。

对于基于连接的服务来说，每个QP都和另一个远端节点相关联。在这种情况下，QP Context（上下文）中包含有远端节点的QP信息。

**在连接服务类型中的每个QP，都和唯一的另一个QP建立了连接，也就是说QP下发的每个WQE的目的地都是唯一的**。
![[Pasted image 20240109171443.png]]


**数据报 Datagram**与连接相反，发端和收端间不需要“建立管道”的步骤，只要发端到收端物理上是可以到达的，那么我就可能从任何路径发给任意的收端节点。**QP下发给硬件的每个WQE都可能指向不同的目的地**。
![[Pasted image 20240109171531.png]]

# 服务类型
上面介绍的两个维度两两组合就形成了IB的四种基本服务类型：
![](https://pic3.zhimg.com/80/v2-37597449e3e4290f3bdf40d5ec23cac6_1440w.webp)

RC和UD是应用最多也是最基础的两种服务类型，我们可以将他们分别类比成TCP/IP协议栈传输层的TCP和UDP。
- RC用于对数据完整性和可靠性要求较高的场景，跟TCP一样，因为需要各种机制来保证可靠，所以开销自然会大一些。
- UD硬件开销小并且节省存储资源，比如N个节点需要相互通信，只需要创建**N**个QP就可以了，但是可靠性跟UDP一样没法保证。

