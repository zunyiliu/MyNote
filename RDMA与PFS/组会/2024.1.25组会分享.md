# Queue Buffer
## 面临的问题
Queue Buffer是RDMA中数据结构Queue在内存中的形式，其面临以下问题：
1. 硬件访问内存用的是DMA地址，即IOVA或PA，并不是用户看到的VA，两者不在同一个地址空间。
2. 操作系统的换页功能会导致虚拟地址与物理地址的映射关系变化。
3. 虚拟地址连续，物理地址不一定连续。

对此，创建QP或其他Queue时，都需要陷入内核态，并进行以下操作：
1. 获取物理内存页的DMA地址。
2. 为虚拟页面映射物理页，并固定虚拟页和物理页间的关系。
3. 以硬件可以识别的方式组织物理内存页的DMA地址。

## 控制路径
### 用户态
用户首先在用户程序中调用Create QP的Verbs API来启动创建QP的流程，随后用户驱动程序会根据用户指定的Queue的深度和硬件WQE大小，申请一片虚拟内存，进而陷入内核态。

### 内核态
内核态获取到用户申请的Buffer信息后，就会开始解决上面提出的三个问题：
1. 系统提供了DMA地址映射接口，来获取物理内存页的DMA地址。
2. 利用Pin机制，将物理页固定在page buffer中，从而固定虚拟也和物理页间的关系
3. 将CPU视角下的SG Table拷贝到一片连续的物理内存中，从而RDMA网卡可以通过这块连续的物理内存得知离散的Buffer信息，结构如下：
![[Pasted image 20240121103229.png]]

通过以上步骤，我们就创建了一个Queue以及其对应的Queue Buffer
## 数据路径
### 用户态
1. 用户的应用程序通过rdma-core提供的Verbs接口来Post Send一个WR
2. 用户态驱动收到用户的WR后，按照格式配置硬件相关的WQE的内容，并放入Queue Buffer中
3. 填写完WQE之后，驱动通过Doorbell机制通知硬件获取WQE

### 内核态
1. 硬件收到Doorbell之后，会解析其内容，拿到对应的QPN和WQE头指针。
2. 通过QPN找到对应的QPC，进而获取QP Buffer内容
3. 通过WQE头指针，在QP Buffer中获取用户下发的WQE，解析后即可进行发送

# MR Buffer
## 面临的问题
RDMA网卡直接从内存读取shu'ju