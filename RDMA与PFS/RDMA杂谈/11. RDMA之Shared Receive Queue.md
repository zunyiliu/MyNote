# 概述
SRQ是IB协议为了给接收端节省资源而设计的。我们可以把一个RQ共享给所有关联的QP使用，这个公用的RQ就称为SRQ。当与其关联的QP想要下发接收WQE时，都填写到这个SRQ中。然后每当硬件接收到数据后，就根据SRQ中的下一个WQE的内容把数据存放到指定位置。

# SRQ和RQ的区别
## RQ的接收流程
0. 创建QP。
1. 通过Post Recv接口，用户分别向QP2和QP3的RQ下发接收WQE，WQE中包含接收到数据后放到哪块内存区域的信息。
2. 硬件收到数据。
3. 硬件发现是发给QP3的，那么从QP3的RQ中取出WQE1，将接收到的数据放到WQE1指定的内存区域。
4. 硬件完成数据存放后，向QP3的RQ关联的CQ3产生一个CQE，上报任务完成信息。
5. 用户从CQ3中取出WC（CQE），然后从指定内存区域取走数据。
6. 硬件收到数据。
7. 硬件发现是发送给QP2的，那么从QP2的RQ中取出WQE1，将接收到的数据放到WQE1指定的内存区域。
8. 硬件完成数据存放后，向QP2的RQ关联的CQ2产生一个CQE，上报任务完成信息。
9. 用户从CQ2中取出WC（CQE），然后从指定内存区域取走数据。
![[Pasted image 20240115160539.png]]

## SRQ的接收流程
0. 创建SRQ1，并创建QP2和QP3，都关联到SRQ1上。

1. 通过Post SRQ Recv接口，用户向SRQ1中下发两个接收WQE，WQE中包含接收到数据后放到哪块内存区域的信息。
2. 硬件收到数据。
3. 硬件发现是发给QP3的，从SRQ1中取出第一个WQE（现在是WQE1），根据WQE内容存放收到的数据。
> SRQ中的每个WQE是“无主的“，不关联到任何一个QP，硬件按队列顺序依次取出WQE就把数据放到里面了。  
4. 硬件发现**QP3的RQ关联的CQ**是CQ3，所以向其中产生一个CQE。
5. 用户从CQ3中取出CQE，从指定内存区域取走数据。
6. 硬件收到数据。
7. 硬件发现是发给QP2的，从SRQ1中取出第一个WQE（现在是WQE2），根据WQE内容存放收到的数据。
8. 硬件发现QP2的RQ关联的CQ是CQ2，所以向其中产生一个CQE。
9. 用户从CQ2中取出CQE，从指定内存区域取走数据。
![[Pasted image 20240115160623.png]]

