# 什么是DMA
DMA全称为Direct Memory Access，即直接内存访问。意思是外设对内存的读写过程可以不用CPU参与而直接进行。

在没有DMA时，当我们需要从内存中拷贝数据到设备的寄存器时，我们需要依靠CPU将用户空间中的数据拷贝到内核空间中，然后再将该数据拷贝到设备的寄存器中。
![[Pasted image 20240109151019.png]]

如果有DMA，我们就可以让DMA来做内存拷贝的工作，这样CPU就可以腾出来做计算工作。
![[Pasted image 20240109151025.png]]

# 什么是RDMA
RDMA（ Remote Direct Memory Access ）意为远程直接地址访问，通过RDMA，本端节点可以“直接”访问远端节点的内存。

传统网络传输需要在CPU的参与下，首先将内存用户空间中的数据拷贝到内核空间，然后经过内核空间中软件实现的TCP/IP协议栈，之后再拷贝到网卡当中。另一端则进行相反的工作。
![[Pasted image 20240109151316.png]]

RDMA技术中不需要CPU的参与，本端的网卡可以直接从内存的用户空间中取出数据，通过硬件实现报文的组装，然后发往另一端。
![[Pasted image 20240109151604.png]]

# RDMA的优势
RDMA设备相对普通以太网卡要昂贵不少，因而主要应用在高性能计算（HPC）领域和大型数据中心当中，其包含以下优势：
- 0拷贝：指的是不需要在用户空间和内核空间中来回复制数据。
- 内核Bypass：指的是IO（数据）流程可以绕过内核，即在用户层就可以把数据准备好并通知硬件准备发送和接收。避免了系统调用和上下文切换的开销。
![[Pasted image 20240109151714.png]]
- CPU卸载：指的是可以在远端节点CPU不参与通信的情况下（当然要持有访问远端某段内存的“钥匙”才行）对内存进行读写，这实际上是**把报文封装和解析放到硬件中做了**。

# 协议
RDMA本身指的是一种技术，具体协议层面，包含Infiniband（IB），RDMA over Converged Ethernet（RoCE）和internet Wide Area RDMA Protocol（iWARP）。三种协议都符合RDMA标准，使用相同的上层接口，在不同层次上有一些差别。
![[Pasted image 20240109151749.png]]

## Infiniband
IB协议是当之无愧的核心，其规定了一整套完整的链路层到传输层（非传统OSI七层模型的传输层，而是位于其之上）规范，但是其无法兼容现有以太网，除了需要支持IB的网卡之外，企业如果想部署的话还要重新购买配套的交换设备。

## RoCE
基于以太网链路层的RDMA协议，v1版本网络层仍然使用了IB规范，而v2使用了UDP+IP作为网络层，使得数据包也可以被路由。RoCE可以被认为是IB的“低成本解决方案”，将IB的报文封装成以太网包进行收发。由于RoCE v2可以使用以太网的交换设备，所以现在在企业中应用也比较多，但是相同场景下相比IB性能要有一些损失。

## iWARP
iWARP协议是IETF基于TCP提出的，因为TCP是面向连接的可靠协议，这使得iWARP在面对有损网络场景（可以理解为网络环境中可能经常出现丢包）时相比于RoCE v2和IB具有更好的可靠性，在大规模组网时也有明显的优势。


