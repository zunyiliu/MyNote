# 引论
在传统TCP-IP协议栈中，使用了家喻户晓的IP地址来标识网络层的每个节点。而IB协议中的这个标识被称为**GID（Global Identifier，全局ID）**，是一个128 bits的序列。关于GID本篇不展开讨论，将在后面介绍。

# AH是什么
AH全称为Address Handle，直译为“地址句柄”。这里的地址，指的是一组用于找到某个远端节点的信息的集合，在IB协议中，地址指的是GID、端口号等等信息；而所谓句柄，我们可以理解为一个指向某个对象的指针。

对于RC服务类型而言，一旦建立连接关系便不容易改变，对端的信息是创建QP的时候储存在QP Context中的；
对于UD服务类型而言，QP间没有连接关系，用户想发给谁，就在WQE中填好对端的地址信息就可以了。**用户不是直接把对端的地址信息填到WQE中的，而是提前准备了一个“地址薄”，每次通过一个索引来指定对端节点的地址信息，而这个索引就是AH**。
![[Pasted image 20240110153335.png]]

# AH的作用
## 1.保证目的地址可用，提高效率
用户在创建AH时会陷入内核态，如果用户传递的参数有效，内核会把这些目的节点信息储存起来，生成一个指针返回给用户；如果用户传递的参数无效，AH将创建失败。这一过程可以保证地址信息是有效的。

## 2.向用户隐藏底层地址细节
用户创建AH时，只需要传递gid、端口号、静态速率等信息，而其他通信所需的地址信息（主要是MAC地址）是内核驱动通过查询系统邻居表等方式解析到的，底层没有必要暴露这些额外的信息给用户层。

## 3.可以使用PD对目的地址进行管理
AH也由PD来进行资源划分。当定义了AH这个软件实体之后，我们就可以对所有的QP可达的目的地进行相互隔离和管理。